# INSTRUCTIONS ‚Äî FRIAXIS (Gest√£o de Dispositivos) ‚Ä¢ MDM Android Corporativo

**Stack:** Next.js (Vercel) + Neon (Postgres) + Firebase (Auth + FCM) + APK (Launcher+Agente)  
**Regras:** Sem realtime cont√≠nuo ‚Ä¢ Localiza√ß√£o sob demanda ‚Ä¢ Captura de tela assistida (com consentimento) ‚Ä¢ Multi-tenant (multi-empresa)

---

## Papel do Assistente
Atue como **arquiteto(a) e dev s√™nior full-stack + Android**.  
Projete, implemente e documente um MDM enxuto para Android com:

- **Painel Web + API** (Next.js no Vercel)  
- **APK Android** (Launcher + Agente)  
- **Neon Postgres** como banco  
- **Firebase** para Auth (web) e FCM (push)

Priorize **simplicidade, seguran√ßa, baixo custo e efici√™ncia**.

---

## Vis√£o Geral
**O que √©:**  
Solu√ß√£o MDM corporativa para Android com **launcher kiosque**, **pol√≠ticas**, **gest√£o de apps**, **comandos sob demanda** e **localiza√ß√£o quando solicitada**.

**Objetivo:**  
Controle corporativo com **baixo custo/complexidade**, sem rastrear 24/7.

**Vantagens:**  
Vercel/Neon free-tier, FCM gratuito, arquitetura serverless-friendly, escal√°vel depois.

### Funcionalidades (MVP)
- **Launcher corporativo (kiosk):** Home com apps permitidos, Lock Task Mode, bloqueios de navega√ß√£o/sistema (quando suportado).  
- **Pol√≠ticas de seguran√ßa:** PIN m√≠nimo, bloquear fontes desconhecidas, depura√ß√£o USB, reset manual etc.  
- **Gest√£o de apps:** permitir/bloquear, instalar/atualizar/remover por pol√≠tica.  
- **Comandos remotos sob demanda:** LOCK/UNLOCK/WIPE/OPEN_ACTIVITY/PING.  
- **Localiza√ß√£o sob demanda:** painel ‚Üí comando ‚Üí push (FCM) ‚Üí GPS ‚Üí resposta.  
- **Telemetria leve:** app ativo, bateria, OS/SSID, invent√°rio b√°sico.  
- **Logs & auditoria:** hist√≥rico de comandos/eventos, export simples (CSV).  
- **Captura de tela assistida:** MediaProjection com consentimento.

---

## Regras Inegoci√°veis
1. Sem rastreamento cont√≠nuo (somente sob demanda).  
2. Sem realtime permanente (usar FCM + polling curto).  
3. Captura de tela exige consentimento de sess√£o.  
4. Efici√™ncia de bateria (servi√ßos s√≥ quando necess√°rios).  
5. Seguran√ßa/LGPD (RBAC, auditoria, reten√ß√£o, HTTPS, segredos em envs).  
6. Serverless-friendly (Neon driver serverless).  
7. Padroniza√ß√£o (Conventional Commits, semver, monorepo, CI).

---

## Arquitetura (2 pe√ßas + 2 servi√ßos)
**Voc√™ desenvolve/publica:**  
1. Painel Web + API (Next.js/TypeScript no Vercel)  
2. APK Android (Kotlin: Launcher + Agente)

**Servi√ßos de suporte:**  
3. Neon (Postgres) ‚Äî dados de devices, pol√≠ticas, comandos, logs, localiza√ß√µes  
4. Firebase ‚Äî Auth e FCM

---

## Multi-Tenant (SaaS para v√°rias empresas)
- Cada **empresa = organiza√ß√£o (org)**.  
- Recursos isolados por `org_id`.  
- Usu√°rios podem pertencer a m√∫ltiplas orgs com pap√©is (`admin`, `operator`, `viewer`).  
- Cobran√ßa mensal via coruzen.com ‚Üí checkout (Stripe/Mercado Pago).  
- Webhook de billing cria `organization` e `subscription`.  
- Org admins geram **tokens de matr√≠cula** (QR provisioning) para devices.  
- **RLS no Postgres** garante isolamento.

### Tabelas adicionais
- `organizations`  
- `org_members`  
- `subscriptions`  
- `enrollment_tokens`

---

## Monorepo (PNPM Workspaces)
```
pnpm-workspace.yaml
/apps
  /web         # Next.js (painel + rotas /api)
  /android     # Android (Launcher + Agent - Kotlin)
/packages
  /shared      # DTOs, tipos, contratos de API, constantes
/infra         # Migra√ß√µes (Prisma/Drizzle), seeds, scripts
/docs          # Guias (QR provision, LGPD, opera√ß√£o)
/.github/workflows
  web-ci.yml       # build/test web; preview; checks
  android-ci.yml   # build APK; release por tag
```

Branches: `main` (produ√ß√£o), `dev` (preview), `feature/*`.  
Releases: tags sem√¢nticas (ex.: v0.2.0) + APK anexado.  
CI: Vercel (web) + GitHub Actions (APK).

---

## Infraestrutura & Dom√≠nios
- **Produ√ß√£o:** `friaxis.coruzen.com` (branch main)  
- **Preview:** `friaxis-dev.coruzen.com` (branch dev)  
- **DNS:** subdom√≠nios em `coruzen.com`  

### Fluxo de Deploy
1. Dev em `feature/*` ‚Üí PR para `dev`.  
2. `dev` ‚Üí deploy autom√°tico em Preview.  
3. Validado ‚Üí merge `main` ‚Üí produ√ß√£o.

---

## Modelagem de Dados
- `organizations`, `org_members`, `subscriptions`, `enrollment_tokens`  
- `devices`, `policies`, `device_policies`, `commands`, `events`, `locations`, `users`

---

## API (contrato m√≠nimo)
- `POST /api/commands`  
- `GET /api/commands/:id`  
- `POST /api/devices/:id/report`  
- `POST /api/devices/:id/location`  
- `GET /api/devices`  
- `GET /api/devices/:id`  
- `POST /api/devices/:id/policy/apply`

Execu√ß√£o: painel cria comando ‚Üí envia FCM ‚Üí APK executa ‚Üí responde ‚Üí painel exibe resultado.

---

## Painel Web (Next.js)
- **Auth:** Firebase Auth (cliente) + verifica√ß√£o ID Token no servidor.  
- **RBAC:** pap√©is por organiza√ß√£o (admin/operator/viewer).  
- **P√°ginas:**  
  - Login  
  - Dispositivos (lista, filtros)  
  - Detalhe (a√ß√µes r√°pidas, mapa Leaflet/OSM, telemetria, apps)  
  - Pol√≠ticas (CRUD/aplicar)  
  - Logs/Auditoria (export CSV)  
- **Boas pr√°ticas:** Tailwind + shadcn/ui, DTOs em `/packages/shared`, valida√ß√£o com Zod, Neon serverless.

---

## Android (Launcher + Agente)
- **Identidade:** `com.coruzen.sdb`  
- **Launcher:** grid apps permitidos; Lock Task Mode; bloqueio de navega√ß√£o.  
- **Agent Core:** FirebaseMessagingService ‚Üí comandos ‚Üí WorkManager (fila offline).  
- **Services:**  
  - Localiza√ß√£o sob demanda (Foreground Service).  
  - Screenshot com MediaProjection (consentimento).  
- **Policy Enforcer:** DevicePolicyManager (PIN, apps, restri√ß√µes).  
- **Permiss√µes:** INTERNET, ACCESS_NETWORK_STATE, RECEIVE_BOOT_COMPLETED, WAKE_LOCK, ACCESS_FINE/COARSE_LOCATION, FOREGROUND_SERVICE, POST_NOTIFICATIONS.  
- **Provisionamento Device Owner:** via QR provisioning.

### Comandos suportados
- PING  
- LOCATE_NOW  
- LOCK / UNLOCK  
- WIPE  
- OPEN_ACTIVITY  
- SCREENSHOT (com sess√£o ativa)

---

## Seguran√ßa & LGPD
- Transpar√™ncia: apenas dispositivos corporativos.  
- Auditoria completa (commands/events).  
- Reten√ß√£o configur√°vel (logs/screenshots).  
- HTTPS obrigat√≥rio, segredos em envs.  
- Proibi√ß√£o de espionagem oculta.

---

## CI/CD
- **Web:** Vercel (preview/prod).  
- **Android:** GitHub Actions builda APK; tag cria Release assinado.  
- Keystore em GitHub Secrets.

---

## Roadmap
- **F0 ‚Äì Funda√ß√£o** ‚úÖ  
- **F1 ‚Äì Devices & Commands** ‚úÖ  
- **F2 ‚Äì Localiza√ß√£o** üöß  
- **F3 ‚Äì Kiosk/Launcher** üìã  
- **F4 ‚Äì A√ß√µes & Logs** üìã  
- **F5 ‚Äì Screenshot assistida** üìã  

---

## Break-Glass / Kill Switch (DEV)
- Gesto oculto no launcher (ex.: 5√ó toque sobre o nome FRIAXIS) abre painel com PIN ‚Üí desativa kiosque.  
- Watchdog de boot: se launcher crashar 3√ó, abre modo manuten√ß√£o para desativar o FRIAXIS.  
- TTL curto (15 min), auditoria em `events`.

---

## Multi-tenant SaaS
- Venda via coruzen.com ‚Üí checkout.  
- Webhook cria `organization` + `subscription`.  
- Acesso via `friaxis.coruzen.com` com org switcher.  
- Tokens de matr√≠cula geram QR para devices.  
- RLS em Postgres garante isolamento.  
- Planos com limites de dispositivos, etc. (Starter/Pro/Enterprise).

---

> **Este instructions.MD √© o prompt can√¥nico do projeto FRIAXIS.**  