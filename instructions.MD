# INSTRUCTIONS ‚Äî FRIAXIS (Gest√£o de Dispositivos) ‚Ä¢ MDM Android Corporativo

**Stack:** Next.js (Vercel) + Neon (Postgres) + Firebase (Auth + FCM) + APK (Launcher+Agente)  
**Regras:** Sem realtime cont√≠nuo ‚Ä¢ Localiza√ß√£o sob demanda ‚Ä¢ Captura de tela assistida (com consentimento) ‚Ä¢ Multi-tenant (multi-empresa)

---

## üöÄ Guia Operacional (Comandos Essenciais)

### **üíª Desenvolvimento Web**
```powershell
# Iniciar servidor de desenvolvimento (CORRETO)
pnpm dev:web                    # A partir da raiz do monorepo

# ‚ùå EVITAR: cd apps/web && pnpm dev (n√£o funciona corretamente)
# ‚úÖ USAR: pnpm dev:web da raiz

# Build para produ√ß√£o
pnpm --filter @sdb/web build

# Instalar depend√™ncias
pnpm install                    # Na raiz instala tudo
```

### **üì± Compila√ß√£o Android**
```powershell
# M√©todo automatizado (RECOMENDADO)
.\build-apk-final.ps1          # Script completo com valida√ß√µes

# M√©todo manual (se script falhar)
cd apps/android
.\gradlew.bat clean            # Limpar build anterior
.\gradlew.bat assembleDebug    # Compilar APK debug
Copy-Item "app/build/outputs/apk/debug/app-debug.apk" "../../SDB-Mobile-debug.apk" -Force
cd ..\..

# Verificar APK gerado
Get-ChildItem SDB-Mobile-debug.apk
```

### **üîß Configura√ß√£o Firebase**
```json
# Localiza√ß√£o: apps/android/app/google-services.json
# Atualizar sempre ap√≥s mudan√ßas no Firebase Console
# Recompilar APK ap√≥s atualiza√ß√µes
```

### **üåê Deploy e Testes**
```powershell
# Testar localmente
pnpm dev:web                   # Web em http://localhost:3000

# Deploy produ√ß√£o (autom√°tico)
git add . && git commit -m "feat: descri√ß√£o" && git push origin main

# Verificar status do sistema
curl http://localhost:3000/api/health  # Local
curl https://friaxis.coruzen.com/api/health  # Produ√ß√£o
```

### **üóÑÔ∏è Banco de Dados**
```sql
-- Executar migra√ß√µes via API
POST /api/migrate              # Criar tabelas base
POST /api/migrate/device-registrations  # Tabela de pareamento

-- Verificar conex√£o
GET /api/dbtest               # Teste de conectividade
```

### **‚ö†Ô∏è Problemas Comuns**
- **PowerShell && erro**: Usar comandos separados ou `;` 
- **pnpm dev n√£o funciona**: Sempre usar `pnpm dev:web` da raiz
- **APK n√£o atualiza**: Fazer clean antes do build
- **Firebase auth erro**: Verificar dom√≠nios autorizados no console
- **Build warnings**: Usar `--no-frozen-lockfile` se necess√°rio

---

## Papel do Assistente
Atue como **arquiteto(a) e dev s√™nior full-stack + Android**.  
Projete, implemente e documente um MDM enxuto para Android com:

- **Painel Web + API** (Next.js no Vercel)  
- **APK Android** (Launcher + Agente)  
- **Neon Postgres** como banco  
- **Firebase** para Auth (web) e FCM (push)

Priorize **simplicidade, seguran√ßa, baixo custo e efici√™ncia**.

---

## Vis√£o Geral
**O que √©:**  
Solu√ß√£o MDM corporativa para Android com **launcher kiosque**, **pol√≠ticas**, **gest√£o de apps**, **comandos sob demanda** e **localiza√ß√£o quando solicitada**.

**Objetivo:**  
Controle corporativo com **baixo custo/complexidade**, sem rastrear 24/7.

**Vantagens:**  
Vercel/Neon free-tier, FCM gratuito, arquitetura serverless-friendly, escal√°vel depois.

### Funcionalidades (MVP)
- **Launcher corporativo (kiosk):** Home com apps permitidos, Lock Task Mode, bloqueios de navega√ß√£o/sistema (quando suportado).  
- **Pol√≠ticas de seguran√ßa:** PIN m√≠nimo, bloquear fontes desconhecidas, depura√ß√£o USB, reset manual etc.  
- **Gest√£o de apps:** permitir/bloquear, instalar/atualizar/remover por pol√≠tica.  
- **Comandos remotos sob demanda:** LOCK/UNLOCK/WIPE/OPEN_ACTIVITY/PING.  
- **Localiza√ß√£o sob demanda:** painel ‚Üí comando ‚Üí push (FCM) ‚Üí GPS ‚Üí resposta.  
- **Telemetria leve:** app ativo, bateria, OS/SSID, invent√°rio b√°sico.  
- **Logs & auditoria:** hist√≥rico de comandos/eventos, export simples (CSV).  
- **Captura de tela assistida:** MediaProjection com consentimento.

---

## Regras Inegoci√°veis
1. Sem rastreamento cont√≠nuo (somente sob demanda).  
2. Sem realtime permanente (usar FCM + polling curto).  
3. Captura de tela exige consentimento de sess√£o.  
4. Efici√™ncia de bateria (servi√ßos s√≥ quando necess√°rios).  
5. Seguran√ßa/LGPD (RBAC, auditoria, reten√ß√£o, HTTPS, segredos em envs).  
6. Serverless-friendly (Neon driver serverless).  
7. Padroniza√ß√£o (Conventional Commits, semver, monorepo, CI).

---

## Arquitetura (2 pe√ßas + 2 servi√ßos)
**Voc√™ desenvolve/publica:**  
1. Painel Web + API (Next.js/TypeScript no Vercel)  
2. APK Android (Kotlin: Launcher + Agente)

**Servi√ßos de suporte:**  
3. Neon (Postgres) ‚Äî dados de devices, pol√≠ticas, comandos, logs, localiza√ß√µes  
4. Firebase ‚Äî Auth e FCM

---

## Multi-Tenant (SaaS para v√°rias empresas)
- Cada **empresa = organiza√ß√£o (org)**.  
- Recursos isolados por `org_id`.  
- Usu√°rios podem pertencer a m√∫ltiplas orgs com pap√©is (`admin`, `operator`, `viewer`).  
- Cobran√ßa mensal via coruzen.com ‚Üí checkout (Stripe/Mercado Pago).  
- Webhook de billing cria `organization` e `subscription`.  
- Org admins geram **tokens de matr√≠cula** (QR provisioning) para devices.  
- **RLS no Postgres** garante isolamento.

### Tabelas adicionais
- `organizations`  
- `org_members`  
- `subscriptions`  
- `enrollment_tokens`

---

## Monorepo (PNPM Workspaces)
```
pnpm-workspace.yaml
/apps
  /web         # Next.js (painel + rotas /api)
  /android     # Android (Launcher + Agent - Kotlin)
/packages
  /shared      # DTOs, tipos, contratos de API, constantes
/infra         # Migra√ß√µes (Prisma/Drizzle), seeds, scripts
/docs          # Guias (QR provision, LGPD, opera√ß√£o)
/.github/workflows
  web-ci.yml       # build/test web; preview; checks
  android-ci.yml   # build APK; release por tag
```

Branches: `main` (produ√ß√£o), `dev` (preview), `feature/*`.  
Releases: tags sem√¢nticas (ex.: v0.2.0) + APK anexado.  
CI: Vercel (web) + GitHub Actions (APK).

### **üìÇ Arquivos Cr√≠ticos do Sistema**
```
üìÅ Configura√ß√£o Firebase
‚îú‚îÄ‚îÄ apps/android/app/google-services.json     # Config Android (SECRET)
‚îú‚îÄ‚îÄ apps/web/lib/firebase-client.ts           # Config Web Client
‚îî‚îÄ‚îÄ apps/web/lib/firebase-admin.ts            # Config Web Server

üìÅ Scripts de Automa√ß√£o  
‚îú‚îÄ‚îÄ build-apk-final.ps1                       # Build APK completo
‚îú‚îÄ‚îÄ fix-api-routes.ps1                        # Corrigir routes din√¢micas
‚îî‚îÄ‚îÄ infra/setup-db.sh                         # Setup banco PostgreSQL

üìÅ Dados Compartilhados
‚îú‚îÄ‚îÄ packages/shared/types.ts                  # Tipos TypeScript
‚îú‚îÄ‚îÄ packages/shared/schemas.ts                # Valida√ß√£o Zod
‚îî‚îÄ‚îÄ packages/shared/constants.ts              # Constantes do sistema

üìÅ Banco de Dados
‚îú‚îÄ‚îÄ infra/schema.sql                          # Schema principal
‚îú‚îÄ‚îÄ infra/seeds.sql                           # Dados de exemplo
‚îî‚îÄ‚îÄ infra/migrations/                         # Migra√ß√µes versionadas

üìÅ Deploy e CI/CD
‚îú‚îÄ‚îÄ .github/workflows/                        # GitHub Actions
‚îú‚îÄ‚îÄ vercel.json                               # Config Vercel (se necess√°rio)
‚îî‚îÄ‚îÄ apps/web/next.config.mjs                  # Config Next.js
```

---

## Infraestrutura & Dom√≠nios
- **Produ√ß√£o:** `friaxis.coruzen.com` (branch main)  
- **Preview:** `friaxis-dev.coruzen.com` (branch dev)  
- **DNS:** subdom√≠nios em `coruzen.com`  

### Fluxo de Deploy
1. Dev em `feature/*` ‚Üí PR para `dev`.  
2. `dev` ‚Üí deploy autom√°tico em Preview.  
3. Validado ‚Üí merge `main` ‚Üí produ√ß√£o.

---

## Modelagem de Dados
- `organizations`, `org_members`, `subscriptions`, `enrollment_tokens`  
- `devices`, `policies`, `device_policies`, `commands`, `events`, `locations`, `users`

---

## API (contrato m√≠nimo)
- `POST /api/commands`  
- `GET /api/commands/:id`  
- `POST /api/devices/:id/report`  
- `POST /api/devices/:id/location`  
- `GET /api/devices`  
- `GET /api/devices/:id`  
- `POST /api/devices/:id/policy/apply`

Execu√ß√£o: painel cria comando ‚Üí envia FCM ‚Üí APK executa ‚Üí responde ‚Üí painel exibe resultado.

---

## Painel Web (Next.js)
- **Auth:** Firebase Auth (cliente) + verifica√ß√£o ID Token no servidor.  
- **RBAC:** pap√©is por organiza√ß√£o (admin/operator/viewer).  
- **P√°ginas:**  
  - Login  
  - Dispositivos (lista, filtros)  
  - Detalhe (a√ß√µes r√°pidas, mapa Leaflet/OSM, telemetria, apps)  
  - Pol√≠ticas (CRUD/aplicar)  
  - Logs/Auditoria (export CSV)  
- **Boas pr√°ticas:** Tailwind + shadcn/ui, DTOs em `/packages/shared`, valida√ß√£o com Zod, Neon serverless.

---

## Android (Launcher + Agente)
- **Identidade:** `com.coruzen.sdb`  
- **Launcher:** grid apps permitidos; Lock Task Mode; bloqueio de navega√ß√£o.  
- **Agent Core:** FirebaseMessagingService ‚Üí comandos ‚Üí WorkManager (fila offline).  
- **Services:**  
  - Localiza√ß√£o sob demanda (Foreground Service).  
  - Screenshot com MediaProjection (consentimento).  
- **Policy Enforcer:** DevicePolicyManager (PIN, apps, restri√ß√µes).  
- **Permiss√µes:** INTERNET, ACCESS_NETWORK_STATE, RECEIVE_BOOT_COMPLETED, WAKE_LOCK, ACCESS_FINE/COARSE_LOCATION, FOREGROUND_SERVICE, POST_NOTIFICATIONS.  
- **Provisionamento Device Owner:** via QR provisioning.

### Comandos suportados
- PING  
- LOCATE_NOW  
- LOCK / UNLOCK  
- WIPE  
- OPEN_ACTIVITY  
- SCREENSHOT (com sess√£o ativa)

---

## Seguran√ßa & LGPD
- Transpar√™ncia: apenas dispositivos corporativos.  
- Auditoria completa (commands/events).  
- Reten√ß√£o configur√°vel (logs/screenshots).  
- HTTPS obrigat√≥rio, segredos em envs.  
- Proibi√ß√£o de espionagem oculta.

---

## CI/CD
- **Web:** Vercel (preview/prod).  
- **Android:** GitHub Actions builda APK; tag cria Release assinado.  
- Keystore em GitHub Secrets.

---

## Roadmap
- **F0 ‚Äì Funda√ß√£o** ‚úÖ  
- **F1 ‚Äì Devices & Commands** ‚úÖ  
- **F2 ‚Äì Localiza√ß√£o** üöß  
- **F3 ‚Äì Kiosk/Launcher** üìã  
- **F4 ‚Äì A√ß√µes & Logs** üìã  
- **F5 ‚Äì Screenshot assistida** üìã  

---

## Break-Glass / Kill Switch (DEV)
- Gesto oculto no launcher (ex.: 5√ó toque sobre o nome FRIAXIS) abre painel com PIN ‚Üí desativa kiosque.  
- Watchdog de boot: se launcher crashar 3√ó, abre modo manuten√ß√£o para desativar o FRIAXIS.  
- TTL curto (15 min), auditoria em `events`.

---

## Multi-tenant SaaS
- Venda via coruzen.com ‚Üí checkout.  
- Webhook cria `organization` + `subscription`.  
- Acesso via `friaxis.coruzen.com` com org switcher.  
- Tokens de matr√≠cula geram QR para devices.  
- RLS em Postgres garante isolamento.  
- Planos com limites de dispositivos, etc. (Starter/Pro/Enterprise).

---

## üìä Status Atual do Projeto (Setembro 2025)

### **‚úÖ Implementado e Funcionando**
- **Web Dashboard**: 100% funcional com mapas, CRUD completo
- **APIs REST**: 11 endpoints implementados e testados
- **Autentica√ß√£o**: Firebase Auth + RBAC (admin/operator/viewer)
- **Android App**: Launcher corporativo + Device Admin + FCM
- **Banco PostgreSQL**: Schema completo + migra√ß√µes + seeds
- **Deploy Autom√°tico**: GitHub ‚Üí Vercel (produ√ß√£o)
- **Build Quality**: Zero warnings, c√≥digo enterprise-grade

### **üöß Em Desenvolvimento (90%+)**
- **F2 - Localiza√ß√£o**: GPS sob demanda implementado
- **F3 - Launcher/Kiosk**: Modo kiosk funcional, pol√≠ticas aplicadas
- **F4 - A√ß√µes & Logs**: Sistema de auditoria completo

### **üìã Pr√≥ximas Prioridades**
1. **Migra√ß√£o dom√≠nio**: sdb.coruzen.com ‚Üí friaxis.coruzen.com
2. **Screenshot assistida**: MediaProjection com consentimento
3. **Multi-tenant**: Implementar organiza√ß√µes e subscriptions
4. **APK Release**: Vers√£o assinada para produ√ß√£o

### **üéØ M√©tricas de Qualidade**
- **Build Status**: ‚úÖ Zero errors, zero warnings
- **Test Coverage**: APIs 100% testadas
- **Security**: HTTPS, RBAC, auditoria completa
- **Performance**: Serverless-ready, otimizado

---

> **Este instructions.MD √© o prompt can√¥nico do projeto FRIAXIS.**  
> **√öltima atualiza√ß√£o**: 18 de Setembro de 2025  
> **Status**: 95% Production Ready üéâ