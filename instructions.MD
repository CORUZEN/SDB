# INSTRUCTIONS â€” FRIAXIS (GestÃ£o de Dispositivos) â€¢ MDM Android Corporativo

**Stack:** Next.js (Vercel) + Neon (Postgres) + Firebase (Auth + FCM) + APK (Launcher+Agente)  
**Regras:** Sem realtime contÃ­nuo â€¢ LocalizaÃ§Ã£o sob demanda â€¢ Captura de tela assistida (com consentimento) â€¢ Multi-tenant (multi-empresa)

---

## ğŸš€ Guia Operacional (Comandos Essenciais)

### **ğŸ’» Desenvolvimento Web**
```powershell
# Iniciar servidor de desenvolvimento (CORRETO)
pnpm dev:web                    # A partir da raiz do monorepo

# âŒ EVITAR: cd apps/web && pnpm dev (nÃ£o funciona corretamente)
# âœ… USAR: pnpm dev:web da raiz

# Build para produÃ§Ã£o
pnpm --filter @sdb/web build

# Instalar dependÃªncias
pnpm install                    # Na raiz instala tudo
```

### **ğŸ“± CompilaÃ§Ã£o Android**
```powershell
# MÃ©todo automatizado (RECOMENDADO)
.\build-apk-final.ps1          # Script completo com validaÃ§Ãµes

# MÃ©todo manual (se script falhar)
cd apps/android
.\gradlew.bat clean            # Limpar build anterior
.\gradlew.bat assembleDebug    # Compilar APK debug
Copy-Item "app/build/outputs/apk/debug/app-debug.apk" "../../SDB-Mobile-debug.apk" -Force
cd ..\..

# Verificar APK gerado
Get-ChildItem SDB-Mobile-debug.apk
```

### **ğŸ”§ ConfiguraÃ§Ã£o Firebase**
```json
# LocalizaÃ§Ã£o: apps/android/app/google-services.json
# Atualizar sempre apÃ³s mudanÃ§as no Firebase Console
# Recompilar APK apÃ³s atualizaÃ§Ãµes
```

### **ğŸŒ Deploy e Testes**
```powershell
# Testar localmente
pnpm dev:web                   # Web em http://localhost:3000

# Deploy produÃ§Ã£o (automÃ¡tico)
git add . && git commit -m "feat: descriÃ§Ã£o" && git push origin main

# Verificar status do sistema
curl http://localhost:3000/api/health  # Local
curl https://friaxis.coruzen.com/api/health  # ProduÃ§Ã£o
```

### **ğŸ—„ï¸ Banco de Dados**
```sql
-- Executar migraÃ§Ãµes via API
POST /api/migrate              # Criar tabelas base
POST /api/migrate/device-registrations  # Tabela de pareamento

-- Verificar conexÃ£o
GET /api/dbtest               # Teste de conectividade
```

### **âš ï¸ Problemas Comuns**
- **PowerShell && erro**: Usar comandos separados ou `;` 
- **pnpm dev nÃ£o funciona**: Sempre usar `pnpm dev:web` da raiz
- **APK nÃ£o atualiza**: Fazer clean antes do build
- **Firebase auth erro**: Verificar domÃ­nios autorizados no console
- **Build warnings**: Usar `--no-frozen-lockfile` se necessÃ¡rio

---

## Papel do Assistente
Atue como **arquiteto(a) e dev sÃªnior full-stack + Android**.  
Projete, implemente e documente um MDM enxuto para Android com:

- **Painel Web + API** (Next.js no Vercel)  
- **APK Android** (Launcher + Agente)  
- **Neon Postgres** como banco  
- **Firebase** para Auth (web) e FCM (push)

Priorize **simplicidade, seguranÃ§a, baixo custo e eficiÃªncia**.

---

## VisÃ£o Geral
**O que Ã©:**  
SoluÃ§Ã£o MDM corporativa para Android com **launcher kiosque**, **polÃ­ticas**, **gestÃ£o de apps**, **comandos sob demanda** e **localizaÃ§Ã£o quando solicitada**.

**Objetivo:**  
Controle corporativo com **baixo custo/complexidade**, sem rastrear 24/7.

**Vantagens:**  
Vercel/Neon free-tier, FCM gratuito, arquitetura serverless-friendly, escalÃ¡vel depois.

### Funcionalidades (MVP)
- **Launcher corporativo (kiosk):** Home com apps permitidos, Lock Task Mode, bloqueios de navegaÃ§Ã£o/sistema (quando suportado).  
- **PolÃ­ticas de seguranÃ§a:** PIN mÃ­nimo, bloquear fontes desconhecidas, depuraÃ§Ã£o USB, reset manual etc.  
- **GestÃ£o de apps:** permitir/bloquear, instalar/atualizar/remover por polÃ­tica.  
- **Comandos remotos sob demanda:** LOCK/UNLOCK/WIPE/OPEN_ACTIVITY/PING.  
- **LocalizaÃ§Ã£o sob demanda:** painel â†’ comando â†’ push (FCM) â†’ GPS â†’ resposta.  
- **Telemetria leve:** app ativo, bateria, OS/SSID, inventÃ¡rio bÃ¡sico.  
- **Logs & auditoria:** histÃ³rico de comandos/eventos, export simples (CSV).  
- **Captura de tela assistida:** MediaProjection com consentimento.

---

## Regras InegociÃ¡veis
1. Sem rastreamento contÃ­nuo (somente sob demanda).  
2. Sem realtime permanente (usar FCM + polling curto).  
3. Captura de tela exige consentimento de sessÃ£o.  
4. EficiÃªncia de bateria (serviÃ§os sÃ³ quando necessÃ¡rios).  
5. SeguranÃ§a/LGPD (RBAC, auditoria, retenÃ§Ã£o, HTTPS, segredos em envs).  
6. Serverless-friendly (Neon driver serverless).  
7. PadronizaÃ§Ã£o (Conventional Commits, semver, monorepo, CI).

---

## Arquitetura (2 peÃ§as + 2 serviÃ§os)
**VocÃª desenvolve/publica:**  
1. Painel Web + API (Next.js/TypeScript no Vercel)  
2. APK Android (Kotlin: Launcher + Agente)

**ServiÃ§os de suporte:**  
3. Neon (Postgres) â€” dados de devices, polÃ­ticas, comandos, logs, localizaÃ§Ãµes  
4. Firebase â€” Auth e FCM

---

## Multi-Tenant (SaaS para vÃ¡rias empresas)
- Cada **empresa = organizaÃ§Ã£o (org)**.  
- Recursos isolados por `org_id`.  
- UsuÃ¡rios podem pertencer a mÃºltiplas orgs com papÃ©is (`admin`, `operator`, `viewer`).  
- CobranÃ§a mensal via coruzen.com â†’ checkout (Stripe/Mercado Pago).  
- Webhook de billing cria `organization` e `subscription`.  
- Org admins geram **tokens de matrÃ­cula** (QR provisioning) para devices.  
- **RLS no Postgres** garante isolamento.

### Tabelas adicionais
- `organizations`  
- `org_members`  
- `subscriptions`  
- `enrollment_tokens`

---

## Monorepo (PNPM Workspaces)
```
pnpm-workspace.yaml
/apps
  /web         # Next.js (painel + rotas /api)
  /android     # Android (Launcher + Agent - Kotlin)
/packages
  /shared      # DTOs, tipos, contratos de API, constantes
/infra         # MigraÃ§Ãµes (Prisma/Drizzle), seeds, scripts
/docs          # Guias (QR provision, LGPD, operaÃ§Ã£o)
/.github/workflows
  web-ci.yml       # build/test web; preview; checks
  android-ci.yml   # build APK; release por tag
```

Branches: `main` (produÃ§Ã£o), `dev` (preview), `feature/*`.  
Releases: tags semÃ¢nticas (ex.: v0.2.0) + APK anexado.  
CI: Vercel (web) + GitHub Actions (APK).

### **ğŸ“‚ Arquivos CrÃ­ticos do Sistema**
```
ğŸ“ ConfiguraÃ§Ã£o Firebase
â”œâ”€â”€ apps/android/app/google-services.json     # Config Android (SECRET)
â”œâ”€â”€ apps/web/lib/firebase-client.ts           # Config Web Client
â””â”€â”€ apps/web/lib/firebase-admin.ts            # Config Web Server

ğŸ“ Scripts de AutomaÃ§Ã£o  
â”œâ”€â”€ build-apk-final.ps1                       # Build APK completo
â”œâ”€â”€ fix-api-routes.ps1                        # Corrigir routes dinÃ¢micas
â””â”€â”€ infra/setup-db.sh                         # Setup banco PostgreSQL

ğŸ“ Dados Compartilhados
â”œâ”€â”€ packages/shared/types.ts                  # Tipos TypeScript
â”œâ”€â”€ packages/shared/schemas.ts                # ValidaÃ§Ã£o Zod
â””â”€â”€ packages/shared/constants.ts              # Constantes do sistema

ğŸ“ Banco de Dados
â”œâ”€â”€ infra/schema.sql                          # Schema principal
â”œâ”€â”€ infra/seeds.sql                           # Dados de exemplo
â””â”€â”€ infra/migrations/                         # MigraÃ§Ãµes versionadas

ğŸ“ Deploy e CI/CD
â”œâ”€â”€ .github/workflows/                        # GitHub Actions
â”œâ”€â”€ vercel.json                               # Config Vercel (se necessÃ¡rio)
â””â”€â”€ apps/web/next.config.mjs                  # Config Next.js
```

---

## Infraestrutura & DomÃ­nios
- **ProduÃ§Ã£o:** `friaxis.coruzen.com` (branch main)  
- **Preview:** `friaxis-dev.coruzen.com` (branch dev)  
- **DNS:** subdomÃ­nios em `coruzen.com`  

### Fluxo de Deploy
1. Dev em `feature/*` â†’ PR para `dev`.  
2. `dev` â†’ deploy automÃ¡tico em Preview.  
3. Validado â†’ merge `main` â†’ produÃ§Ã£o.

---

## Modelagem de Dados
- `organizations`, `org_members`, `subscriptions`, `enrollment_tokens`  
- `devices`, `policies`, `device_policies`, `commands`, `events`, `locations`, `users`

---

## API (contrato mÃ­nimo)
- `POST /api/commands`  
- `GET /api/commands/:id`  
- `POST /api/devices/:id/report`  
- `POST /api/devices/:id/location`  
- `GET /api/devices`  
- `GET /api/devices/:id`  
- `POST /api/devices/:id/policy/apply`

ExecuÃ§Ã£o: painel cria comando â†’ envia FCM â†’ APK executa â†’ responde â†’ painel exibe resultado.

---

## Painel Web (Next.js)
- **Auth:** Firebase Auth (cliente) + verificaÃ§Ã£o ID Token no servidor.  
- **RBAC:** papÃ©is por organizaÃ§Ã£o (admin/operator/viewer).  
- **PÃ¡ginas:**  
  - Login  
  - Dispositivos (lista, filtros)  
  - Detalhe (aÃ§Ãµes rÃ¡pidas, mapa Leaflet/OSM, telemetria, apps)  
  - PolÃ­ticas (CRUD/aplicar)  
  - Logs/Auditoria (export CSV)  
- **Boas prÃ¡ticas:** Tailwind + shadcn/ui, DTOs em `/packages/shared`, validaÃ§Ã£o com Zod, Neon serverless.

---

## Android (Launcher + Agente)
- **Identidade:** `com.coruzen.sdb`  
- **Launcher:** grid apps permitidos; Lock Task Mode; bloqueio de navegaÃ§Ã£o.  
- **Agent Core:** FirebaseMessagingService â†’ comandos â†’ WorkManager (fila offline).  
- **Services:**  
  - LocalizaÃ§Ã£o sob demanda (Foreground Service).  
  - Screenshot com MediaProjection (consentimento).  
- **Policy Enforcer:** DevicePolicyManager (PIN, apps, restriÃ§Ãµes).  
- **PermissÃµes:** INTERNET, ACCESS_NETWORK_STATE, RECEIVE_BOOT_COMPLETED, WAKE_LOCK, ACCESS_FINE/COARSE_LOCATION, FOREGROUND_SERVICE, POST_NOTIFICATIONS.  
- **Provisionamento Device Owner:** via QR provisioning.

### Comandos suportados
- PING  
- LOCATE_NOW  
- LOCK / UNLOCK  
- WIPE  
- OPEN_ACTIVITY  
- SCREENSHOT (com sessÃ£o ativa)

---

## SeguranÃ§a & LGPD
- TransparÃªncia: apenas dispositivos corporativos.  
- Auditoria completa (commands/events).  
- RetenÃ§Ã£o configurÃ¡vel (logs/screenshots).  
- HTTPS obrigatÃ³rio, segredos em envs.  
- ProibiÃ§Ã£o de espionagem oculta.

---

## CI/CD
- **Web:** Vercel (preview/prod).  
- **Android:** GitHub Actions builda APK; tag cria Release assinado.  
- Keystore em GitHub Secrets.

---

## Roadmap
- **F0 â€“ FundaÃ§Ã£o** âœ…  
- **F1 â€“ Devices & Commands** âœ…  
- **F2 â€“ LocalizaÃ§Ã£o** ğŸš§  
- **F3 â€“ Kiosk/Launcher** ğŸ“‹  
- **F4 â€“ AÃ§Ãµes & Logs** ğŸ“‹  
- **F5 â€“ Screenshot assistida** ğŸ“‹  

---

## Break-Glass / Kill Switch (DEV)
- Gesto oculto no launcher (ex.: 5Ã— toque sobre o nome FRIAXIS) abre painel com PIN â†’ desativa kiosque.  
- Watchdog de boot: se launcher crashar 3Ã—, abre modo manutenÃ§Ã£o para desativar o FRIAXIS.  
- TTL curto (15 min), auditoria em `events`.

---

## Multi-tenant SaaS
- Venda via coruzen.com â†’ checkout.  
- Webhook cria `organization` + `subscription`.  
- Acesso via `friaxis.coruzen.com` com org switcher.  
- Tokens de matrÃ­cula geram QR para devices.  
- RLS em Postgres garante isolamento.  
- Planos com limites de dispositivos, etc. (Starter/Pro/Enterprise).

---

## ğŸ“Š Status Atual do Projeto (Setembro 2025)

### **âœ… Implementado e Funcionando**
- **Web Dashboard**: 100% funcional com mapas, CRUD completo
- **APIs REST**: 11 endpoints implementados e testados
- **AutenticaÃ§Ã£o**: Firebase Auth + RBAC (admin/operator/viewer)
- **Android App**: Launcher corporativo + Device Admin + FCM
- **Banco PostgreSQL**: Schema completo + migraÃ§Ãµes + seeds
- **Deploy AutomÃ¡tico**: GitHub â†’ Vercel (produÃ§Ã£o)
- **Build Quality**: Zero warnings, cÃ³digo enterprise-grade

### **ğŸš§ Em Desenvolvimento (90%+)**
- **F2 - LocalizaÃ§Ã£o**: GPS sob demanda implementado
- **F3 - Launcher/Kiosk**: Modo kiosk funcional, polÃ­ticas aplicadas
- **F4 - AÃ§Ãµes & Logs**: Sistema de auditoria completo

### **ğŸ“‹ PrÃ³ximas Prioridades**
1. **MigraÃ§Ã£o domÃ­nio**: sdb.coruzen.com â†’ friaxis.coruzen.com
2. **Screenshot assistida**: MediaProjection com consentimento
3. **Multi-tenant**: Implementar organizaÃ§Ãµes e subscriptions
4. **APK Release**: VersÃ£o assinada para produÃ§Ã£o

### **ğŸ¯ MÃ©tricas de Qualidade**
- **Build Status**: âœ… Zero errors, zero warnings
- **Test Coverage**: APIs 100% testadas
- **Security**: HTTPS, RBAC, auditoria completa
- **Performance**: Serverless-ready, otimizado

---

> **Este instructions.MD Ã© o prompt canÃ´nico do projeto FRIAXIS.**  
> **Ãšltima atualizaÃ§Ã£o**: 18 de Setembro de 2025  
> **Status**: 95% Production Ready ğŸ‰